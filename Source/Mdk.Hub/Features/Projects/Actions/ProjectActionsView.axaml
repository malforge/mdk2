<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:actions="clr-namespace:Mdk.Hub.Features.Projects.Actions"
             xmlns:overview="clr-namespace:Mdk.Hub.Features.Projects.Overview"
             xmlns:controls="clr-namespace:Mdk.Hub.Framework.Controls"
             xmlns:icons="clr-namespace:Mdk.Hub.Features.Projects.Overview.Icons"
             xmlns:options="clr-namespace:Mdk.Hub.Features.Projects.Options"
             xmlns:i="https://github.com/projektanker/icons.avalonia"
             mc:Ignorable="d" d:DesignWidth="400" d:DesignHeight="600"
             x:Class="Mdk.Hub.Features.Projects.Actions.ProjectActionsView"
             x:DataType="actions:ProjectActionsViewModel">
    <UserControl.Resources>
        <actions:BoolToDeploymentStatusConverter x:Key="BoolToDeploymentStatusConverter" />
        <actions:BoolToWarningBackgroundConverter x:Key="BoolToWarningBackgroundConverter" />
    </UserControl.Resources>
    
    <Design.DataContext>
        <actions:ProjectActionsViewModel />
    </Design.DataContext>

    <UserControl.Styles>
        <StyleInclude Source="avares://Mdk.Hub/Features/Projects/Actions/Styles.axaml" />
    </UserControl.Styles>

    <UserControl.DataTemplates>
        <icons:SymbolSelector>
            <icons:ProjectTypeDefinition Type="IngameScript">
                <DataTemplate>
                    <icons:ProgrammableBlockSymbol />
                </DataTemplate>
            </icons:ProjectTypeDefinition>
            <icons:ProjectTypeDefinition Type="Mod">
                <DataTemplate>
                    <icons:ModSymbol />
                </DataTemplate>
            </icons:ProjectTypeDefinition>
        </icons:SymbolSelector>
        
        <!-- Create Project Action -->
        <DataTemplate DataType="actions:CreateProjectAction">
            <StackPanel Spacing="8" Margin="16,0">
                <TextBlock Classes="section-title" Text="Projects" />
                <ItemsControl ItemsSource="{Binding Options}">
                    <ItemsControl.ItemsPanel>
                        <ItemsPanelTemplate>
                            <StackPanel Spacing="2" />
                        </ItemsPanelTemplate>
                    </ItemsControl.ItemsPanel>
                    <ItemsControl.ItemTemplate>
                        <DataTemplate>
                            <Border Classes="create-hover-row" 
                                    Padding="10" 
                                    CornerRadius="4" 
                                    Cursor="Hand"
                                    Tapped="OnCreateOptionTapped"
                                    Tag="{Binding}">
                                <Grid ColumnDefinitions="Auto,*">
                                    <ContentControl Content="{Binding ProjectType}" Width="32" Height="32" Grid.Column="0" />
                                    <StackPanel Grid.Column="1" Margin="10,0,0,0" VerticalAlignment="Center" Spacing="1">
                                        <TextBlock Text="{Binding Title}" FontSize="13" FontWeight="Medium" />
                                        <TextBlock Text="{Binding Description}" FontSize="11" Classes="very-muted" />
                                    </StackPanel>
                                </Grid>
                            </Border>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>
                
                <!-- Add Existing Project -->
                <Border Classes="create-hover-row" 
                        Padding="10" 
                        CornerRadius="4" 
                        Cursor="Hand"
                        Tapped="OnAddExistingProjectTapped"
                        Tag="{Binding AddExistingAction}">
                    <Grid ColumnDefinitions="Auto,*">
                        <i:Icon Value="fa-solid fa-folder-open" 
                                FontSize="18" 
                                Width="32" 
                                Height="32" 
                                Grid.Column="0"
                                VerticalAlignment="Center"
                                HorizontalAlignment="Center" />
                        <StackPanel Grid.Column="1" Margin="10,0,0,0" VerticalAlignment="Center" Spacing="1">
                            <TextBlock Text="Add Existing Project" FontSize="13" FontWeight="Medium" />
                            <TextBlock Text="Open an existing MDK² project" FontSize="11" Classes="very-muted" />
                        </StackPanel>
                    </Grid>
                </Border>
            </StackPanel>
        </DataTemplate>

        <!-- Category Separator -->
        <DataTemplate DataType="actions:CategorySeparator">
            <Border Height="1" Background="{StaticResource BorderPrimaryBrush}" Margin="0,12" />
        </DataTemplate>

        <!-- Project Info -->
        <DataTemplate DataType="actions:ProjectInfoAction">
            <StackPanel Spacing="12" Margin="16,0">
                <!-- Project header -->
                <StackPanel Spacing="12" Orientation="Horizontal">
                    <ContentControl Content="{Binding Project.Type}" Width="48" Height="48" />
                    <StackPanel Spacing="4" VerticalAlignment="Center">
                        <TextBlock Classes="section-title" Text="{Binding Project.Name}" />
                        <TextBlock Classes="info-label" Text="{Binding ProjectTypeName}" />
                    </StackPanel>
                </StackPanel>
                
                <!-- Configuration Warning -->
                <Border Background="{StaticResource AccentDangerBrush}" 
                        Opacity="0.2"
                        CornerRadius="4" 
                        Padding="12"
                        IsVisible="{Binding ConfigurationWarning, Converter={x:Static StringConverters.IsNotNullOrEmpty}}">
                    <StackPanel Spacing="4">
                        <TextBlock Text="⚠ Configuration Issues" 
                                   Classes="danger" 
                                   FontWeight="SemiBold" 
                                   FontSize="12" />
                        <TextBlock Text="{Binding ConfigurationWarning}" 
                                   TextWrapping="Wrap"
                                   Classes="danger"
                                   FontSize="11" />
                    </StackPanel>
                </Border>
                
                <!-- Info grid -->
                <Grid ColumnDefinitions="Auto,*" RowDefinitions="Auto,Auto,Auto" ColumnSpacing="16" RowSpacing="8">
                    <!-- Row 1: Deployment Status | Last Deployed -->
                    <StackPanel Grid.Column="0" Grid.Row="0" Spacing="4" 
                                HorizontalAlignment="Left" VerticalAlignment="Top">
                        <TextBlock Classes="info-label" Text="Deployment Status:" />
                        <TextBlock Classes="info-value" 
                                   Text="{Binding IsDeployed, Converter={StaticResource BoolToDeploymentStatusConverter}}" 
                                   IsVisible="{Binding !DeploymentError}" />
                        <TextBlock Classes="info-value danger" 
                                   Text="{Binding DeploymentError}" 
                                   IsVisible="{Binding DeploymentError, Converter={x:Static StringConverters.IsNotNullOrEmpty}}" />
                    </StackPanel>
                    
                    <StackPanel Grid.Column="1" Grid.Row="0" Spacing="4" 
                                HorizontalAlignment="Left" VerticalAlignment="Top"
                                IsVisible="{Binding IsDeployed}">
                        <TextBlock Classes="info-label" Text="Last Deployed:" />
                        <controls:DateTimeDisplay Value="{Binding LastDeployed}" />
                    </StackPanel>
                    
                    <!-- Row 2: Last Changed (full width) -->
                    <StackPanel Grid.Column="0" Grid.Row="1" Grid.ColumnSpan="2" Spacing="4"
                                HorizontalAlignment="Left" VerticalAlignment="Top">
                        <TextBlock Classes="info-label" Text="Last Changed:" />
                        <controls:DateTimeDisplay Value="{Binding LastChanged}" 
                                                  IsVisible="{Binding !LastChangedError}" />
                        <TextBlock Classes="info-value danger" 
                                   Text="{Binding LastChangedError}" 
                                   IsVisible="{Binding LastChangedError, Converter={x:Static StringConverters.IsNotNullOrEmpty}}" />
                    </StackPanel>
                    
                    <!-- Row 3: Script Size (full width, highlighted if over limit) -->
                    <Border Grid.Column="0" Grid.Row="2" Grid.ColumnSpan="2" 
                            IsVisible="{Binding IsScript}"
                            Background="{Binding IsScriptTooLarge, Converter={StaticResource BoolToWarningBackgroundConverter}}"
                            CornerRadius="4"
                            Padding="8"
                            ClipToBounds="True"
                            HorizontalAlignment="Stretch">
                        <StackPanel Spacing="4">
                            <TextBlock Classes="info-label" Text="Script Size:" />
                            <StackPanel Orientation="Horizontal" Spacing="8">
                                <TextBlock Classes="info-value" Text="{Binding ScriptSizeCharacters, StringFormat='{}{0:N0} characters'}" />
                                <TextBlock Classes="info-value danger" 
                                           Text="⚠ Exceeds SE limit (100,000 characters)" 
                                           FontWeight="Bold"
                                           IsVisible="{Binding IsScriptTooLarge}" />
                            </StackPanel>
                        </StackPanel>
                    </Border>
                </Grid>
                
                <!-- Action toolbar -->
                <Border Classes="action-toolbar" Padding="8" CornerRadius="4" Background="{StaticResource BorderLightColor}" Opacity="0.67">
                    <StackPanel Orientation="Horizontal" Spacing="4" HorizontalAlignment="Center">
                        <Button Classes="toolbar-button subtle" ToolTip.Tip="Open in IDE"
                                Command="{Binding OpenInIdeCommand}">
                            <i:Icon Value="fa-solid fa-code" FontSize="16" />
                        </Button>
                        <Border Width="1" Height="24" Background="{StaticResource BorderMediumColor}" Margin="4,0" />
                        <Button Classes="toolbar-button subtle" ToolTip.Tip="Open Project Folder"
                                Command="{Binding OpenProjectFolderCommand}">
                            <i:Icon Value="fa-solid fa-folder" FontSize="16" />
                        </Button>
                        <Button Classes="toolbar-button subtle" ToolTip.Tip="Open Output Folder"
                                Command="{Binding OpenOutputFolderCommand}">
                            <i:Icon Value="fa-solid fa-folder-open" FontSize="16" />
                        </Button>
                        <Border Width="1" Height="24" Background="{StaticResource BorderMediumColor}" Margin="4,0" />
                        <Button Classes="toolbar-button subtle" ToolTip.Tip="Options"
                                Command="{Binding ShowOptionsCommand}">
                            <i:Icon Value="fa-solid fa-cog" FontSize="16" />
                        </Button>
                        <Button Classes="toolbar-button subtle" ToolTip.Tip="Copy Script to Clipboard"
                                Command="{Binding CopyScriptCommand}"
                                IsVisible="{Binding IsScript}">
                            <i:Icon Value="fa-solid fa-copy" FontSize="16" />
                        </Button>
                        <Border Width="1" Height="24" Background="{StaticResource BorderMediumColor}" Margin="4,0" />
                        <Button Classes="toolbar-button subtle danger" ToolTip.Tip="Delete Project"
                                Command="{Binding Project.DeleteCommand}">
                            <i:Icon Value="fa-solid fa-trash" FontSize="16" />
                        </Button>
                    </StackPanel>
                </Border>
            </StackPanel>
        </DataTemplate>

        <!-- Project Action Button -->
        <DataTemplate DataType="actions:ProjectAction">
            <Button Classes="action-button subtle" Content="{Binding Title}" HorizontalAlignment="Stretch" Margin="16,0" />
        </DataTemplate>
        
        <!-- Update Packages Action -->
        <DataTemplate DataType="actions:UpdatePackagesAction">
            <Border Classes="action-item" Margin="16,0">
                <StackPanel Spacing="8">
                    <TextBlock Classes="action-title" Text="MDK Package Updates" FontSize="14" FontWeight="SemiBold" />
                    <TextBlock Classes="action-description" Text="Update MDK packages for this project or all projects" FontSize="12" />
                    
                    <StackPanel Orientation="Horizontal" Spacing="8" Margin="0,8,0,0">
                        <Button Content="Update This Project"
                                Command="{Binding UpdateThisProjectCommand}"
                                HorizontalAlignment="Left" />
                        <Button Content="Update All Projects"
                                Command="{Binding UpdateAllProjectsCommand}"
                                HorizontalAlignment="Left" />
                    </StackPanel>
                </StackPanel>
            </Border>
        </DataTemplate>
        
        <!-- API Documentation Action -->
        <DataTemplate DataType="actions:ApiDocsAction">
            <Button Classes="action-button subtle" 
                    Command="{Binding ExecuteCommand}" 
                    HorizontalAlignment="Stretch" 
                    Margin="16,0"
                    Padding="10"
                    CornerRadius="4">
                <Grid ColumnDefinitions="Auto,*">
                    <i:Icon Value="{Binding Icon}" 
                            FontSize="16" 
                            Width="24" 
                            Height="24" 
                            Grid.Column="0"
                            VerticalAlignment="Center"
                            HorizontalAlignment="Center" />
                    <StackPanel Grid.Column="1" Margin="10,0,0,0" VerticalAlignment="Center" Spacing="1">
                        <TextBlock Text="{Binding Title}" FontSize="13" FontWeight="Medium" />
                        <TextBlock Text="{Binding Description}" FontSize="11" Classes="very-muted" />
                    </StackPanel>
                </Grid>
            </Button>
        </DataTemplate>
    </UserControl.DataTemplates>

    <Grid RowDefinitions="Auto,*">
        <!-- Header bar with Global Settings and About buttons -->
        <Border Grid.Row="0" 
                Height="40"
                Margin="8"
                Padding="8,0"
                HorizontalAlignment="Stretch">
            <StackPanel Orientation="Horizontal" 
                        HorizontalAlignment="Right"
                        Spacing="4">
                <Button Classes="subtle"
                        VerticalAlignment="Center"
                        Padding="8"
                        ToolTip.Tip="Global Settings"
                        Command="{Binding OpenGlobalSettingsCommand}">
                    <i:Icon Value="fa-solid fa-gear" FontSize="16" />
                </Button>
                <Button Classes="subtle"
                        VerticalAlignment="Center"
                        Padding="8"
                        ToolTip.Tip="About MDK² Hub"
                        Command="{Binding ShowAboutCommand}">
                    <i:Icon Value="fa-solid fa-circle-info" FontSize="16" />
                </Button>
            </StackPanel>
        </Border>
        
        <!-- Main content -->
        <ScrollViewer Grid.Row="1">
            <ItemsControl ItemsSource="{Binding Actions}" Margin="0,16">
                <ItemsControl.ItemsPanel>
                    <ItemsPanelTemplate>
                        <StackPanel Spacing="8" />
                    </ItemsPanelTemplate>
                </ItemsControl.ItemsPanel>
            </ItemsControl>
        </ScrollViewer>
        
        <!-- Options Drawer (slides in from right) -->
        <Border x:Name="OptionsDrawer"
                Grid.Row="0"
                Grid.RowSpan="2"
                Classes="drawer-content"
                BorderBrush="{StaticResource BorderPrimaryBrush}"
                BorderThickness="1,0,0,0"
                HorizontalAlignment="Stretch"
                VerticalAlignment="Stretch"
                Margin="80,0,0,0"
                Padding="16"
                IsVisible="False"
                RenderTransformOrigin="0.5,0.5">
            <Border.RenderTransform>
                <TranslateTransform X="1000"/>
            </Border.RenderTransform>
            
            <Grid RowDefinitions="Auto,*">
                <!-- Header with close button -->
                <Border Grid.Row="0" 
                        Classes="drawer-header"
                        Margin="-16,-16,-16,16">
                    <Grid ColumnDefinitions="*,Auto">
                        <TextBlock Grid.Column="0"
                                   Text="Project Options"
                                   FontSize="18"
                                   FontWeight="Bold"
                                   Classes="primary"
                                   VerticalAlignment="Center"/>
                        <Button Grid.Column="1"
                                Classes="subtle"
                                Content="✕"
                                FontSize="16"
                                Padding="8,4"
                                Click="OnCloseDrawerClick"
                                ToolTip.Tip="Close"/>
                    </Grid>
                </Border>
                
                <!-- Options content -->
                <options:ProjectOptionsView Grid.Row="1" DataContext="{Binding OptionsViewModel}"/>
            </Grid>
        </Border>
    </Grid>
</UserControl>
