<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://wixtoolset.org/schemas/v4/wxs"
     xmlns:ui="http://wixtoolset.org/schemas/v4/wxs/ui"
     xmlns:util="http://wixtoolset.org/schemas/v4/wxs/util">
  
  <?define ProductName = "MDK Hub" ?>
  <?define ProductVersion = "1.0.0" ?>
  <?define Manufacturer = "Malware's Development Kit" ?>
  <?define UpgradeCode = "A5F8B3C9-4D2E-4A1B-8C7D-9E5F6A3B2C1D" ?>
  <?define HubPublishDir = "..\Mdk.Hub\bin\Release\net9.0-windows\win-x64\publish\" ?>
  
  <Package Name="$(var.ProductName)"
           Version="$(var.ProductVersion)"
           Manufacturer="$(var.Manufacturer)"
           UpgradeCode="$(var.UpgradeCode)"
           Compressed="yes"
           InstallerVersion="500">
    
    <MajorUpgrade DowngradeErrorMessage="A newer version of [ProductName] is already installed."
                  Schedule="afterInstallInitialize" />
    
    <Media Id="1" Cabinet="media1.cab" EmbedCab="yes" />
    
    <!-- Include WixUI for standard installer dialogs -->
    <ui:WixUI Id="WixUI_InstallDir" InstallDirectory="INSTALLFOLDER" />
    <UIRef Id="WixUI_ErrorProgressText" />
    
    <!-- Customize the UI by skipping the license dialog -->
    <UI>
      <!-- Skip from WelcomeDlg directly to InstallDirDlg -->
      <Publish Dialog="WelcomeDlg" Control="Next" Event="NewDialog" Value="InstallDirDlg" Order="2" />
      <Publish Dialog="InstallDirDlg" Control="Back" Event="NewDialog" Value="WelcomeDlg" />
    </UI>
    
    <!-- Branding: Custom banner (493x58) and dialog (493x312) images -->
    <WixVariable Id="WixUIBannerBmp" Value="..\Mdk.Hub\Assets\installer-banner.png" />
    <WixVariable Id="WixUIDialogBmp" Value="..\Mdk.Hub\Assets\installer-dialog.png" />
    
    <!-- Properties for launch after install -->
    <Property Id="WIXUI_EXITDIALOGOPTIONALCHECKBOXTEXT" Value="Launch MDK Hub" />
    <Property Id="WIXUI_EXITDIALOGOPTIONALCHECKBOX" Value="1" />
    
    <!-- Set the target for WixShellExec -->
    <SetProperty Id="WixShellExecTarget" 
                 Value="[INSTALLFOLDER]Mdk.Hub.exe" 
                 Before="LaunchApplication" 
                 Sequence="execute"
                 Condition="WIXUI_EXITDIALOGOPTIONALCHECKBOX = 1 and NOT Installed" />
    
    <!-- Custom action: Launch executable after install using WixShellExec -->
    <CustomAction Id="LaunchApplication" 
                  BinaryRef="Wix4UtilCA_$(sys.BUILDARCHSHORT)" 
                  DllEntry="WixShellExec" 
                  Execute="immediate" 
                  Return="check" 
                  Impersonate="yes" />
    
    <InstallExecuteSequence>
      <Custom Action="LaunchApplication" After="InstallFinalize" Condition="WIXUI_EXITDIALOGOPTIONALCHECKBOX = 1 and NOT Installed" />
    </InstallExecuteSequence>
    
    <!--  Standard folder structure -->
    <StandardDirectory Id="ProgramFiles64Folder">
      <Directory Id="INSTALLFOLDER" Name="MDK Hub" />
    </StandardDirectory>
    
    <!-- Shortcuts for the main executable -->
    <StandardDirectory Id="ProgramMenuFolder">
      <Component Id="StartMenuShortcutComponent">
        <Shortcut Id="StartMenuShortcut"
                  Name="MDK Hub"
                  Description="Malware's Development Kit Hub for Space Engineers"
                  Target="[INSTALLFOLDER]Mdk.Hub.exe"
                  WorkingDirectory="INSTALLFOLDER"
                  Icon="ProductIcon.ico"
                  IconIndex="0" />
        <RegistryValue Root="HKCU" Key="Software\MDK\Hub" Name="installed" Type="integer" Value="1" KeyPath="yes" />
      </Component>
    </StandardDirectory>
    
    <!-- Icon for Add/Remove Programs and shortcuts -->
    <Icon Id="ProductIcon.ico" SourceFile="$(var.ProjectDir)..\Mdk.Hub\Assets\malware.ico" />
    <Property Id="ARPPRODUCTICON" Value="ProductIcon.ico" />
    
    <!-- Add/Remove Programs customization -->
    <Property Id="ARPHELPLINK" Value="https://github.com/malware-dev/mdk2" />
    
    <!-- Feature to install -->
    <Feature Id="Complete" Level="1">
      <ComponentGroupRef Id="HubPublishedFiles" />
      <ComponentRef Id="StartMenuShortcutComponent" />
    </Feature>
  </Package>
</Wix>
