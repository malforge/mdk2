<?xml version="1.0" encoding="utf-8"?>
<Project>
    <PropertyGroup>
        <MdkBuildConfiguration>all</MdkBuildConfiguration>
        <MdkArguments />
        <MdkInteractive>auto</MdkInteractive>
        
        <!-- Convert MdkInteractive property to CLI flag -->
        <!-- 'auto' = don't override, let INI/CLI defaults decide -->
        <!-- Empty or 'no' = explicitly disable interactive mode -->
        <MdkInteractiveFlag Condition="'$(MdkInteractive)' == '' Or '$(MdkInteractive)' == 'no'">-interactive DoNothing</MdkInteractiveFlag>
        <MdkInteractiveFlag Condition="'$(MdkInteractive)' != '' And '$(MdkInteractive)' != 'no' And '$(MdkInteractive)' != 'auto'">-interactive $(MdkInteractive)</MdkInteractiveFlag>
        <!-- 'auto' = MdkInteractiveFlag stays empty = no flag passed -->
        
        <!-- Detect CLI binary based on OS -->
        <MdkRuntimeIdentifier Condition="'$(OS)' == 'Windows_NT'">win-x64</MdkRuntimeIdentifier>
        <MdkRuntimeIdentifier Condition="'$(OS)' != 'Windows_NT'">linux-x64</MdkRuntimeIdentifier>
        <MdkCliExecutable Condition="'$(OS)' == 'Windows_NT'">mdk.exe</MdkCliExecutable>
        <MdkCliExecutable Condition="'$(OS)' != 'Windows_NT'">mdk</MdkCliExecutable>
        <MdkCliPath>$(MSBuildThisFileDirectory)..\tools\$(MdkRuntimeIdentifier)\$(MdkCliExecutable)</MdkCliPath>
    </PropertyGroup>
    
    <ItemGroup>
        <AdditionalFiles Include="**\*.ini" />
    </ItemGroup>
    
    <Target Name="MdkPack" AfterTargets="PostBuildEvent" Condition="'$(Configuration)' == '$(MdkBuildConfiguration)' Or '$(MdkBuildConfiguration)' == 'all'">
        <Exec Command="&quot;$(MdkCliPath)&quot; pack &quot;$(MSBuildProjectFullPath)&quot; $(MdkArguments) -configuration $(Configuration) $(MdkInteractiveFlag)" ContinueOnError="true">
            <Output TaskParameter="ExitCode" PropertyName="MdkExitCode"/>
        </Exec>
        <Error Condition="'$(MdkExitCode)' != '0'" Text="MDK could not package the project. Please check the build output." />
    </Target>
    
    <Target Name="MdkDidNotPack" AfterTargets="PostBuildEvent" Condition="'$(Configuration)' != '$(MdkBuildConfiguration)' And '$(MdkBuildConfiguration)' != 'all'">
        <Exec Command="echo MDK did not pack, because the current configuration is '$(Configuration)', not '$(MdkBuildConfiguration)'." />
    </Target>   

</Project>